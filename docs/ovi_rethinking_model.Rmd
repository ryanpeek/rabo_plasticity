---
title: "Oviposition Logistic"
author: "Ryan Peek"
date: "Updated: `r format(Sys.Date())`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../"))
```

## Try Model, Model Fail

Let's try to assess whether water temperature, air temperature, flow (daily/weekly recession rates & discharge) play a role in predicting when breeding (oviposition occurs). To build this model we need to block by river, and by water year, as these are independent (though water year isn't *fixed*, it is fixed across all sites per each year).

First let's take a look at some test data. Using a subset (say just pull the **NF American**), can we build a model that gets at whether there is predictability in these variables despite shifts in timing and magnitude from year to year?

### Get the Data & Tidy

```{r get and tidy data}
library(tidyverse)
library(lubridate)

load("data/master_dat_2011-2016.rda") 
load("data/flow_dv_cfs_2011_6sites.rda") # updated and merged flows:

#df <- master_df
# df <- master_df %>% filter(site!="MFY")
df <- master_df %>% filter(month(date)>3 & month(date)<8 & !site=="MFA")
#df <- master_df %>% filter(month(date)>3 & month(date)<8 & site=="NFA" | site=="NFY")

# 2 NAs in dataset from 30 day avgs
df[!is.na(df$missData) & df$site=="RUB" & df$date==ymd("2011-05-26"),]$temp_30_max<-10.99
df[!is.na(df$missData) & df$site=="RUB" & df$date==ymd("2011-05-26"),]$temp_30_min<-9.7

rabo <- df[!is.na(df$missData),] %>% arrange(date)

# refactor the sites to drop unused factors
rabo$site <- factor(rabo$site)

# add unique rownames based on siteID
rabo <- rabo %>%
  mutate("siteID" = paste0(site, "-", row.names(.))) %>% 
  column_to_rownames(var = "siteID")  %>% as.data.frame
names(rabo)
rownames(rabo)

d <- rabo %>% dplyr::select(-(obs_strt:apr_jul), -len_km, -starts_with("CDEC"), -station, -WY, -DOY)

names(d)

```


## Rethinking Model

```{r varying effects, eval=F, echo=T}
library(rethinking)

# fix index
d$river <- as.integer(as.factor(d$site))

# from Jacob 05/17/17
mz43 <- map2stan(
  alist(
    DOWY ~ dgampois(mu,scale),
    log(mu) <- a_river[river_id] + bt7*temp_7_avg + bwyi*Index + bdeltLev * deltLev +
      bQCV * Q_CV + bdeltQ * deltQ + bQ*Q_cfs + bWair*W_air_30_max + btCV*temp_CV,
    a_river[river_id] ~ dcauchy(10,sigma_site),
    sigma_site ~ dcauchy(1,1),
    c(bt7, bwyi, bdeltLev, bQCV, bdelQ, bQ, bWair, btCV) ~ dnorm(0,1),
    scale ~ dcauchy(0,2)
  ),
  data=d,
  constraints=list(scale="lower=0"),
  start=list(scale=2)
)

```


## LASSO glm 

```{r lasso}

library(glmnet)

# Only UNREG
d.1 <- dplyr::select(d, DOWY, everything(), -date, -EM_per_km, -REG) %>% 
  filter(site=="NFY" | site=="NFA") %>% 
  as.data.frame

# add id and site to rownames:
row.names(d.1) <- paste0(d.1$site, "-", row.names(d.1))
d.1 <- select(d.1, -site)
#d.1$site <- as.integer(as.factor(d.1$site))

x <- model.matrix(DOWY~., data=d.1)
x <- x[,-1]

fit = glmnet(x=x, y=d.1$DOWY)
plot(fit, label=T)
print(fit)
coef(fit,s=0.1)

nx = matrix(rnorm(12*30),12,30)
predict(fit,newx=nx,s=c(0.1,0.05))

cvfit <- cv.glmnet(x=x, y=d.1$DOWY)
plot(cvfit)
cvfit$lambda.min
```

lamda.min is the value of 位位 that gives minimum mean cross-validated error. The other 位位 saved is lambda.1se, which gives the most regularized model such that error is within one standard error of the minimum. To use that, we only need to replace lambda.min with lambda.1se above

```{r}

coef(cvfit, s = "lambda.min")

predict(cvfit, newx = x, s = "lambda.min")


```

Results as:

```
NFA-1  271.6041
NFY-2  273.1697
NFA-3  230.2935
NFY-4  233.4648
NFA-5  223.4183
NFY-6  224.8586
NFA-7  219.2167
NFY-8  219.7139
NFA-9  214.2525
NFY-10 216.5532
NFA-11 237.7204
NFY-12 238.7343
```


## Logistic `glm` Model

Now let's run a model. See [here](http://stats.idre.ucla.edu/r/dae/logit-regression/)

```{r model}

# All sites
d.2 <- dplyr::select(d, DOWY, everything(), -date, -Index, -WYsum, -EM_per_km) %>%
  as.data.frame

# fix index
d.2$site <- as.integer(as.factor(d.2$site))
d.2$REG <- as.integer(as.factor(d.2$REG))
d.2.s<-scale(d.2) %>% as.data.frame

# run a logistic binomial response model (unscaled)
mylogit2 <- glm(DOWY ~ deltQ + Q_CV + Q_7_CV +
                 W_air_7_avg + W_air_30_max + W_humidity_avg +
                 temp_7_avg + temp_7_max + temp_30_min + temp_30_max +
                 temp_CV + lev_CV + lev_avg + deltLev +
                 days_no_ppt, data = d.2, family = "gaussian")
summary(mylogit2)

# run a logistic binomial response model (unscaled)
mylogit2.s <- glm(DOWY ~ deltQ + Q_CV + Q_7_CV +
                 W_air_7_avg + W_air_30_max + W_humidity_avg +
                 temp_7_avg + temp_7_max + temp_30_min + temp_30_max +
                 temp_CV + lev_CV + lev_avg + deltLev +
                 days_no_ppt, data = d.2.s, family = "gaussian")
summary(mylogit2.s)

```

So **Deviance residuals** are a measure of model fit, and `AIC = 178.8`. For every one unit change in **`temp_7_max`** there is a log-odds of oviposition timing (breeding) increase of 20.2224, whereas a change in the stage (`lev_CV`) yields a strong negative change in the log odds of oviposition by -2.09

You can calculate the confidence intervals using the `confint` function.

```{r}
confint(mylogit2.s)

library(aod)
# Can use a wald.test to test coefficients in order they appear in model
aod::wald.test(b= coef(mylogit2), Sigma = vcov(mylogit2), Terms=c(1,2))
aod::wald.test(b= coef(mylogit2), Sigma = vcov(mylogit2), Terms=c(1,13))

## odds ratios and 95% CI
exp(cbind(OR = coef(mylogit2), confint(mylogit2)))

```

```{r}
# simulate and predict

newdata1 <- d %>% select(DOWY, site, lev_avg:deltQ) %>% group_by(site,  DOY) #%>% 
  summarize(airmin.7 = mean(airmin.7),
            days_wo_ppt = mean(days_wo_ppt),
            level.avg = mean(level.avg),
            temp.min.7 = mean(temp.min.7),
            level.7dL = mean(level.7dL))

# predict
newdata1$rankP <- predict(mylogit, newdata = newdata1, type = "response")
newdata1
ggplot() + geom_point(data=newdata1, aes(x=DOY, y=rankP, color=as.factor(river_id), shape=as.factor(WY_id)), size=3)
```


